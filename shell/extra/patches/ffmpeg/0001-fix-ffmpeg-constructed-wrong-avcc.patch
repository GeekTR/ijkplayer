From b2f570232f5e92b5e768605d44c8dab5be270321 Mon Sep 17 00:00:00 2001
From: qianlongxu <qianlongxu@gmail.com>
Date: Wed, 16 Mar 2022 16:44:08 +0800
Subject: [PATCH] fix ffmpeg constructed wrong avcc

---
 libavcodec/videotoolbox.c | 22 +++++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

diff --git a/libavcodec/videotoolbox.c b/libavcodec/videotoolbox.c
index 57b6698e1b9..76cf78163ae 100644
--- a/libavcodec/videotoolbox.c
+++ b/libavcodec/videotoolbox.c
@@ -152,7 +152,27 @@ CFDataRef ff_videotoolbox_avcc_extradata_create(AVCodecContext *avctx)
     if (vtctx)
         memcpy(vtctx->sps, h->ps.sps->data + 1, 3);
 
-    data = CFDataCreate(kCFAllocatorDefault, vt_extradata, vt_extradata_size);
+    /*
+    ffmpeg constructed avcc is wrong,but i dont't why;eg:
+    ff constructed avcc:
+    014d401effe1001b674d401eec806c1ef3fff8140013f88000000080000019078b16cb01000468ebec4c
+    avctx->extradata avcc:
+    014d401effe1001c674d401eec806c1ef3fff8140013f8800000030080000019078b16cb01000568ebec4c80
+    */
+    if (avctx->extradata_size != vt_extradata_size) {
+        av_log(avctx, AV_LOG_WARNING, "ff avcc maybe wrong:");
+        for(int i = 0; i < vt_extradata_size; i++) {
+            av_log(avctx, AV_LOG_WARNING, "%02x",vt_extradata[i]);
+        }
+        av_log(avctx, AV_LOG_WARNING, "\nuse origin avcc:");
+        for(int i = 0; i < avctx->extradata_size; i++) {
+            av_log(avctx, AV_LOG_WARNING, "%02x",avctx->extradata[i]);
+        }
+        av_log(avctx, AV_LOG_WARNING, "\n");
+        data = CFDataCreate(kCFAllocatorDefault, avctx->extradata, avctx->extradata_size);
+    } else {
+        data = CFDataCreate(kCFAllocatorDefault, vt_extradata, vt_extradata_size);
+    }
     av_free(vt_extradata);
     return data;
 }
-- 
2.30.1 (Apple Git-130)

